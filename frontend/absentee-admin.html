<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absentee Management - NLPC Admin</title>
    <style>
        :root {
            --color-primary: #02a2bc;
            --color-primary-hover: #0a7a92;
            --color-success: #28a745;
            --color-error: #dc3545;
            --color-warning: #ffc107;
            --color-text: #333;
            --color-text-secondary: #666;
            --color-bg: linear-gradient(135deg, #02a2bc 0%, #0a7a92 100%);
            --color-surface: #ffffff;
            --color-border: #e0e0e0;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            font-family: var(--font-family);
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
        }

        body {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            height: 60px;
            width: auto;
            border-radius: 8px;
            padding: 8px 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, #02a2bc 0%, #0a7a92 100%);
        }

        .header h1 {
            color: white;
            font-size: 24px;
            margin: 0;
        }

        .header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px 0 12px;
            border-radius: 8px 8px 0 0;
        }

        .nav-tab {
            padding: 10px 16px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .nav-tab.active {
            color: var(--color-warning);
            border-bottom-color: var(--color-warning);
        }

        .nav-tab:hover {
            color: var(--color-warning);
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .card {
            background: var(--color-surface);
            border: 1px solid rgba(33, 128, 161, 0.15);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(33, 128, 161, 0.08);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--color-text);
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="password"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(94, 82, 64, 0.3);
            border-radius: 6px;
            font-family: var(--font-family);
            font-size: 14px;
            color: var(--color-text);
            background: white;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 161, 0.1);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-family);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: white;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }

        .btn-secondary:hover {
            background: rgba(33, 128, 161, 0.05);
        }

        .btn-danger {
            background: var(--color-error);
            color: white;
        }

        .btn-danger:hover {
            background: #A01627;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-warning {
            background: var(--color-warning);
            color: #333;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
        }

        .summary-card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid var(--color-primary);
            text-align: center;
        }

        .summary-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .summary-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 4px;
        }

        .summary-card.sick {
            border-left-color: var(--color-error);
        }
        .summary-card.sick .summary-value {
            color: var(--color-error);
        }

        .summary-card.vacation {
            border-left-color: var(--color-success);
        }
        .summary-card.vacation .summary-value {
            color: var(--color-success);
        }

        .summary-card.business {
            border-left-color: #6c757d;
        }
        .summary-card.business .summary-value {
            color: #6c757d;
        }

        .summary-card.prayer {
            border-left-color: var(--color-warning);
        }
        .summary-card.prayer .summary-value {
            color: #856404;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
        }

        th {
            background: rgba(33, 128, 161, 0.05);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: var(--color-text);
            border-bottom: 1px solid rgba(94, 82, 64, 0.2);
            white-space: nowrap;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(94, 82, 64, 0.1);
            font-size: 14px;
        }

        tr:hover {
            background: rgba(33, 128, 161, 0.02);
        }

        .reason-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .reason-sick {
            background: rgba(220, 53, 69, 0.15);
            color: #c82333;
        }

        .reason-vacation {
            background: rgba(40, 167, 69, 0.15);
            color: #1e7e34;
        }

        .reason-business {
            background: rgba(108, 117, 125, 0.15);
            color: #495057;
        }

        .reason-other {
            background: rgba(2, 162, 188, 0.15);
            color: #0a7a92;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-sent {
            background: rgba(40, 167, 69, 0.15);
            color: #1e7e34;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.15);
            color: #856404;
        }

        .prayer-text {
            max-width: 300px;
            font-size: 12px;
            color: var(--color-text-secondary);
            font-style: italic;
        }

        .password-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        .password-value {
            font-size: 36px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            letter-spacing: 4px;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .password-meta {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--color-success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-success {
            background: rgba(50, 184, 198, 0.1);
            color: #1D6B73;
            border: 1px solid rgba(50, 184, 198, 0.3);
        }

        .alert-error {
            background: rgba(192, 21, 47, 0.1);
            color: #7A0D22;
            border: 1px solid rgba(192, 21, 47, 0.3);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(33, 128, 161, 0.2);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Login Overlay */
        .login-overlay {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #02a2bc 0%, #0a7a92 100%);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .login-card img {
            height: 80px;
            width: auto;
            margin-bottom: 20px;
            border-radius: 8px;
            padding: 12px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, #02a2bc 0%, #0a7a92 100%);
        }

        .login-card h2 {
            margin: 0 0 8px 0;
            color: #333;
        }

        .login-card p {
            color: #666;
            margin-bottom: 24px;
        }

        .copy-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .copy-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-card">
            <img src="/logo.png" alt="NLPC Logo">
            <h2>Absentee Management</h2>
            <p>Please log in to continue</p>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <input type="text" id="loginUsername" placeholder="Username" required style="text-align: center; font-size: 16px;" autocomplete="username">
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" placeholder="Password" required style="text-align: center; font-size: 16px;" autocomplete="current-password">
                </div>
                <div id="loginAlert"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">Login</button>
            </form>
        </div>
    </div>

    <a href="/" style="color: white; text-decoration: none; font-size: 14px; display: inline-block; margin-bottom: 16px;">← Back to Dashboard</a>

    <!-- Main Content -->
    <div class="header">
        <div class="header-left">
            <img src="/logo.png" alt="NLPC Logo" class="logo">
            <div>
                <h1>Absentee Management</h1>
                <p>Live stream access and weekly reports</p>
            </div>
        </div>
        <div class="header-actions">
            <a href="/absent" class="btn btn-warning" target="_blank">Public Check-In Form</a>
            <a href="/" class="btn btn-secondary">Main App</a>
        </div>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchView('dashboard')">Dashboard</button>
        <button class="nav-tab" onclick="switchView('checkins')">All Check-Ins</button>
        <button class="nav-tab" onclick="switchView('reports')">Reports</button>
        <button class="nav-tab" onclick="switchView('password')">Live Stream Password</button>
    </div>

    <!-- Dashboard View -->
    <div id="dashboard" class="view active">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">This Week's Overview</h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="date" id="dashboardFromDate" style="width: auto;">
                    <span>to</span>
                    <input type="date" id="dashboardToDate" style="width: auto;">
                    <button class="btn btn-sm btn-primary" onclick="loadDashboard()">Update</button>
                </div>
            </div>

            <div id="summaryCards" class="grid-4" style="margin-bottom: 24px;">
                <!-- Summary cards will be loaded here -->
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Prayer Requests</h3>
            </div>
            <div id="prayerRequests">
                <!-- Prayer requests will be loaded here -->
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Recent Check-Ins by Reason</h3>
            </div>
            <div id="groupedCheckins">
                <!-- Grouped check-ins will be loaded here -->
            </div>
        </div>
    </div>

    <!-- All Check-Ins View -->
    <div id="checkins" class="view">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">All Absentee Check-Ins</h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <select id="filterReason" onchange="loadCheckins()">
                        <option value="all">All Reasons</option>
                        <option value="sick">Sick / Prayer Request</option>
                        <option value="vacation">Vacation</option>
                        <option value="business">Business Travel</option>
                        <option value="other">Other</option>
                    </select>
                    <input type="date" id="filterFromDate" style="width: auto;" onchange="loadCheckins()">
                    <span>to</span>
                    <input type="date" id="filterToDate" style="width: auto;" onchange="loadCheckins()">
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table id="checkinsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Reason</th>
                            <th>Date</th>
                            <th>Stream Sent</th>
                            <th>Prayer Request</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="checkinsTableBody">
                        <!-- Table rows will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Reports View -->
    <div id="reports" class="view">
        <div class="card">
            <h3 class="card-title">Generate Weekly Report</h3>
            <div class="grid-3" style="margin-top: 16px;">
                <div class="form-group">
                    <label>From Date</label>
                    <input type="date" id="reportFromDate">
                </div>
                <div class="form-group">
                    <label>To Date</label>
                    <input type="date" id="reportToDate">
                </div>
                <div class="form-group">
                    <label>Email To (optional)</label>
                    <input type="email" id="reportEmail" placeholder="pastor@nlpc.net">
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-primary" onclick="generateReport()">View Report</button>
                <button class="btn btn-success" onclick="sendReport()">Email Report</button>
            </div>
        </div>

        <div id="reportResults">
            <!-- Report results will be loaded here -->
        </div>
    </div>

    <!-- Password Management View -->
    <div id="password" class="view">
        <div class="card">
            <h3 class="card-title">Current Live Stream Password</h3>
            <div id="currentPassword" class="password-display">
                <div class="loading"></div>
                <p>Loading...</p>
            </div>
            <div style="display: flex; gap: 8px; justify-content: center;">
                <button class="btn btn-danger" onclick="changePassword()">Generate New Password</button>
                <button class="btn btn-secondary" onclick="copyPassword()">Copy Password</button>
            </div>
        </div>

        <div class="card">
            <h3 class="card-title">Live Stream Settings</h3>
            <div class="grid-2" style="margin-top: 16px;">
                <div class="form-group">
                    <label>Vimeo Video/Event ID</label>
                    <input type="text" id="vimeoVideoId" placeholder="123456789">
                    <small style="color: var(--color-text-secondary); font-size: 12px;">
                        The ID from your Vimeo video or live event URL
                    </small>
                </div>
                <div class="form-group">
                    <label>Video URL (optional)</label>
                    <input type="text" id="vimeoVideoUrl" placeholder="https://vimeo.com/event/123456">
                    <small style="color: var(--color-text-secondary); font-size: 12px;">
                        The full URL to share with absentees
                    </small>
                </div>
            </div>
            <button class="btn btn-primary" onclick="saveVimeoSettings()">Save Settings</button>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Automatic Password Rotation</h3>
                <label class="toggle-switch">
                    <input type="checkbox" id="rotationEnabled" onchange="toggleRotation()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <p style="color: var(--color-text-secondary); margin-bottom: 16px;">
                When enabled, the password will automatically change on a schedule.
            </p>
            <div class="grid-2">
                <div class="form-group">
                    <label>Day of Week</label>
                    <select id="rotationDay">
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Time</label>
                    <input type="time" id="rotationTime" value="08:00">
                </div>
            </div>
            <button class="btn btn-secondary" onclick="saveRotationSchedule()">Save Schedule</button>
            <div id="scheduleStatus" style="margin-top: 12px;"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/.netlify/functions';
        let currentPassword = null;

        // Helper: Get local date string
        function getLocalDate(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Helper: Get week dates
        function getWeekDates() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - dayOfWeek);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            return {
                from: getLocalDate(startOfWeek),
                to: getLocalDate(endOfWeek)
            };
        }

        // Initialize date fields
        function initDates() {
            const week = getWeekDates();
            document.getElementById('dashboardFromDate').value = week.from;
            document.getElementById('dashboardToDate').value = week.to;
            document.getElementById('filterFromDate').value = week.from;
            document.getElementById('filterToDate').value = week.to;
            document.getElementById('reportFromDate').value = week.from;
            document.getElementById('reportToDate').value = week.to;
        }

        // View switching
        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(viewName).classList.add('active');
            event.target.classList.add('active');

            if (viewName === 'dashboard') loadDashboard();
            if (viewName === 'checkins') loadCheckins();
            if (viewName === 'password') loadPassword();
        }

        // Format reason for display
        function formatReason(reason) {
            const labels = {
                sick: 'Sick / Prayer Request',
                vacation: 'Vacation',
                business: 'Business Travel',
                other: 'Other'
            };
            return labels[reason] || reason;
        }

        // Get reason badge class
        function getReasonClass(reason) {
            return `reason-${reason || 'other'}`;
        }

        // Show alert
        function showAlert(container, message, type) {
            document.getElementById(container).innerHTML = `
                <div class="alert alert-${type}">${message}</div>
            `;
        }

        // Load Dashboard
        async function loadDashboard() {
            const fromDate = document.getElementById('dashboardFromDate').value;
            const toDate = document.getElementById('dashboardToDate').value;

            try {
                const response = await fetch(`${API_BASE}/absentee-dashboard?fromDate=${fromDate}&toDate=${toDate}`);
                const data = await response.json();

                if (data.success) {
                    // Summary cards
                    document.getElementById('summaryCards').innerHTML = `
                        <div class="summary-card">
                            <div class="summary-value">${data.summary.total}</div>
                            <div class="summary-label">Total Check-Ins</div>
                        </div>
                        <div class="summary-card sick">
                            <div class="summary-value">${data.summary.sick}</div>
                            <div class="summary-label">Sick / Prayer</div>
                        </div>
                        <div class="summary-card vacation">
                            <div class="summary-value">${data.summary.vacation}</div>
                            <div class="summary-label">Vacation</div>
                        </div>
                        <div class="summary-card prayer">
                            <div class="summary-value">${data.summary.prayerRequests}</div>
                            <div class="summary-label">Prayer Requests</div>
                        </div>
                    `;

                    // Prayer requests
                    const prayerItems = data.checkins.filter(c => c.prayer_request);
                    if (prayerItems.length > 0) {
                        document.getElementById('prayerRequests').innerHTML = prayerItems.map(p => `
                            <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #ffc107;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${p.name}</div>
                                <div style="font-size: 14px; color: #666;">${p.prayer_request}</div>
                                <div style="font-size: 12px; color: #999; margin-top: 4px;">${new Date(p.created_at).toLocaleDateString()}</div>
                            </div>
                        `).join('');
                    } else {
                        document.getElementById('prayerRequests').innerHTML = '<p style="color: #999;">No prayer requests this week</p>';
                    }

                    // Grouped check-ins
                    let groupedHtml = '';
                    for (const [reason, items] of Object.entries(data.grouped)) {
                        if (items.length > 0) {
                            groupedHtml += `
                                <div style="margin-bottom: 16px;">
                                    <h4 style="margin-bottom: 8px;">
                                        <span class="reason-badge ${getReasonClass(reason)}">${formatReason(reason)}</span>
                                        <span style="color: #999; font-weight: normal;">(${items.length})</span>
                                    </h4>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${items.map(i => `
                                            <span style="background: #f8f9fa; padding: 6px 12px; border-radius: 4px; font-size: 13px;">
                                                ${i.name}
                                                ${i.livestream_sent ? '<span style="color: #28a745;">✓</span>' : ''}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    }
                    document.getElementById('groupedCheckins').innerHTML = groupedHtml || '<p style="color: #999;">No check-ins this week</p>';
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Load All Check-Ins
        async function loadCheckins() {
            const fromDate = document.getElementById('filterFromDate').value;
            const toDate = document.getElementById('filterToDate').value;
            const reason = document.getElementById('filterReason').value;

            try {
                let url = `${API_BASE}/absentee-dashboard?fromDate=${fromDate}&toDate=${toDate}`;
                if (reason !== 'all') url += `&reason=${reason}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    const tbody = document.getElementById('checkinsTableBody');
                    if (data.checkins.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">No check-ins found</td></tr>';
                        return;
                    }

                    tbody.innerHTML = data.checkins.map(c => `
                        <tr id="row-${c.id}">
                            <td><strong>${c.name}</strong></td>
                            <td><a href="tel:${c.phone}" style="color: var(--color-primary);">${c.phone}</a></td>
                            <td><span class="reason-badge ${getReasonClass(c.reason)}">${formatReason(c.reason)}</span></td>
                            <td>${new Date(c.service_date).toLocaleDateString()}</td>
                            <td>${c.livestream_sent
                                ? '<span class="status-badge status-sent">Sent</span>'
                                : '<span class="status-badge status-pending">Pending</span>'
                            }</td>
                            <td class="prayer-text">${c.prayer_request || '—'}</td>
                            <td style="white-space: nowrap;">${new Date(c.created_at).toLocaleString()}</td>
                            <td><button class="btn btn-sm btn-danger" onclick="deleteCheckin('${c.id}', '${c.name.replace(/'/g, "\\'")}')">Delete</button></td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading check-ins:', error);
            }
        }

        // Delete Check-In
        async function deleteCheckin(id, name) {
            if (!confirm(`Delete check-in for "${name}"? This cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/delete-absentee?id=${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    // Remove row from table
                    const row = document.getElementById(`row-${id}`);
                    if (row) {
                        row.remove();
                    }
                    // Reload dashboard if on that view
                    loadDashboard();
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete'));
                }
            } catch (error) {
                console.error('Error deleting check-in:', error);
                alert('Error deleting check-in');
            }
        }

        // Generate Report
        async function generateReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;

            document.getElementById('reportResults').innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading"></div><p>Generating report...</p></div>';

            try {
                const response = await fetch(`${API_BASE}/absentee-report?fromDate=${fromDate}&toDate=${toDate}`);
                const data = await response.json();

                if (data.success) {
                    const report = data.report;

                    let html = `
                        <div class="card">
                            <h3>Report: ${new Date(report.dateRange.from).toLocaleDateString()} - ${new Date(report.dateRange.to).toLocaleDateString()}</h3>
                            <div class="grid-3" style="margin: 16px 0;">
                                <div class="summary-card">
                                    <div class="summary-value">${report.total}</div>
                                    <div class="summary-label">Total Check-Ins</div>
                                </div>
                                <div class="summary-card prayer">
                                    <div class="summary-value">${report.prayerRequests.length}</div>
                                    <div class="summary-label">Prayer Requests</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-value">${report.byReason.length}</div>
                                    <div class="summary-label">Categories</div>
                                </div>
                            </div>
                        </div>
                    `;

                    // By reason
                    report.byReason.forEach(group => {
                        html += `
                            <div class="card">
                                <h4>${group.reason} (${group.count})</h4>
                                <table style="margin-top: 12px;">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Date</th>
                                            <th>Stream Sent</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${group.items.map(i => `
                                            <tr>
                                                <td>${i.name}</td>
                                                <td>${i.phone}</td>
                                                <td>${new Date(i.serviceDate).toLocaleDateString()}</td>
                                                <td>${i.livestreamSent ? '✓' : '—'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    });

                    // Prayer requests
                    if (report.prayerRequests.length > 0) {
                        html += `
                            <div class="card" style="background: #fff3cd;">
                                <h4 style="color: #856404;">Prayer Requests</h4>
                                ${report.prayerRequests.map(p => `
                                    <div style="background: white; padding: 12px; border-radius: 6px; margin-top: 12px;">
                                        <div style="font-weight: 600;">${p.name}</div>
                                        <div style="margin-top: 4px;">${p.request}</div>
                                        <div style="font-size: 12px; color: #999; margin-top: 4px;">${new Date(p.date).toLocaleDateString()}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    document.getElementById('reportResults').innerHTML = html;
                }
            } catch (error) {
                console.error('Error generating report:', error);
                document.getElementById('reportResults').innerHTML = '<div class="card"><div class="alert alert-error">Error generating report</div></div>';
            }
        }

        // Send Report via Email
        async function sendReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            const email = document.getElementById('reportEmail').value;

            if (!email) {
                alert('Please enter an email address');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/absentee-report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fromDate, toDate, email })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`Report sent to ${email}`);
                } else {
                    alert('Error: ' + (data.error || 'Failed to send report'));
                }
            } catch (error) {
                console.error('Error sending report:', error);
                alert('Error sending report');
            }
        }

        // Load Password
        async function loadPassword() {
            try {
                const response = await fetch(`${API_BASE}/vimeo-password`);
                const data = await response.json();

                if (data.success && data.hasPassword) {
                    currentPassword = data.current;
                    document.getElementById('currentPassword').innerHTML = `
                        <div class="password-value">${data.current.password}</div>
                        <div class="password-meta">
                            Video ID: ${data.current.videoId}<br>
                            Created: ${new Date(data.current.createdAt).toLocaleString()}<br>
                            Type: ${data.current.rotationType}
                        </div>
                    `;
                    document.getElementById('vimeoVideoId').value = data.current.videoId || '';
                    document.getElementById('vimeoVideoUrl').value = data.current.videoUrl || '';
                } else {
                    document.getElementById('currentPassword').innerHTML = `
                        <div style="color: #999;">No password configured</div>
                        <p style="font-size: 14px; margin-top: 8px;">Click "Generate New Password" to create one</p>
                    `;
                }

                // Load rotation schedule
                const scheduleResponse = await fetch(`${API_BASE}/rotation-schedule`);
                const scheduleData = await scheduleResponse.json();
                if (scheduleData.success) {
                    document.getElementById('rotationEnabled').checked = scheduleData.schedule.enabled;
                    document.getElementById('rotationDay').value = scheduleData.schedule.day_of_week;
                    document.getElementById('rotationTime').value = scheduleData.schedule.time_of_day?.slice(0, 5) || '08:00';

                    if (scheduleData.schedule.last_run) {
                        document.getElementById('scheduleStatus').innerHTML = `
                            <small style="color: #666;">Last run: ${new Date(scheduleData.schedule.last_run).toLocaleString()}</small>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading password:', error);
            }
        }

        // Change Password
        async function changePassword() {
            if (!confirm('Generate a new password? The current password will be replaced.')) return;

            const videoId = document.getElementById('vimeoVideoId').value;
            const videoUrl = document.getElementById('vimeoVideoUrl').value;

            if (!videoId) {
                alert('Please enter a Vimeo Video ID first');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/vimeo-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoId, videoUrl })
                });

                const data = await response.json();
                if (data.success) {
                    currentPassword = data.password;
                    loadPassword();
                    alert(`New password: ${data.password.password}\n\n${data.vimeoUpdated ? 'Vimeo has been updated.' : 'Note: Vimeo update pending - ' + (data.vimeoError || 'configure VIMEO_ACCESS_TOKEN')}`);
                } else {
                    alert('Error: ' + (data.error || 'Failed to change password'));
                }
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Error changing password');
            }
        }

        // Copy Password
        function copyPassword() {
            if (currentPassword) {
                navigator.clipboard.writeText(currentPassword.password);
                alert('Password copied to clipboard!');
            }
        }

        // Save Vimeo Settings
        async function saveVimeoSettings() {
            const videoUrl = document.getElementById('vimeoVideoUrl').value;

            try {
                const response = await fetch(`${API_BASE}/vimeo-password`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoUrl })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Settings saved!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to save settings'));
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings');
            }
        }

        // Toggle Rotation
        async function toggleRotation() {
            const enabled = document.getElementById('rotationEnabled').checked;

            try {
                const response = await fetch(`${API_BASE}/rotation-schedule`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });

                const data = await response.json();
                if (!data.success) {
                    document.getElementById('rotationEnabled').checked = !enabled;
                    alert('Error: ' + (data.error || 'Failed to toggle rotation'));
                }
            } catch (error) {
                document.getElementById('rotationEnabled').checked = !enabled;
                console.error('Error toggling rotation:', error);
            }
        }

        // Save Rotation Schedule
        async function saveRotationSchedule() {
            const dayOfWeek = parseInt(document.getElementById('rotationDay').value);
            const timeOfDay = document.getElementById('rotationTime').value;

            try {
                const response = await fetch(`${API_BASE}/rotation-schedule`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dayOfWeek, timeOfDay: timeOfDay + ':00' })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Schedule saved!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to save schedule'));
                }
            } catch (error) {
                console.error('Error saving schedule:', error);
                alert('Error saving schedule');
            }
        }

        // Authentication
        function checkAuth() {
            const isAuthenticated = sessionStorage.getItem('nlpc_authenticated') === 'true';
            const loginOverlay = document.getElementById('loginOverlay');

            if (!isAuthenticated) {
                loginOverlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            } else {
                loginOverlay.style.display = 'none';
                document.body.style.overflow = '';
                initDates();
                loadDashboard();
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE}/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'login', username, password })
                });

                const result = await response.json();

                if (result.success) {
                    sessionStorage.setItem('nlpc_authenticated', 'true');
                    sessionStorage.setItem('nlpc_user', JSON.stringify(result.user));
                    document.getElementById('loginOverlay').style.display = 'none';
                    document.body.style.overflow = '';
                    initDates();
                    loadDashboard();
                } else {
                    showAlert('loginAlert', result.error || 'Invalid username or password', 'error');
                }
            } catch (error) {
                console.error('Error logging in:', error);
                showAlert('loginAlert', 'Error connecting to server', 'error');
            }
        }

        // Initialize
        window.addEventListener('load', checkAuth);
    </script>
</body>
</html>
