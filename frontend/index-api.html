<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NLPC Attendance Tracker</title>
    <style>
        :root {
            --color-primary: #02a2bc;
            --color-primary-hover: #0a7a92;
            --color-success: #28a745;
            --color-error: #dc3545;
            --color-text: #333;
            --color-text-secondary: #666;
            --color-bg: linear-gradient(135deg, #02a2bc 0%, #0a7a92 100%);
            --color-surface: white;
            --color-border: #e0e0e0;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { font-family: var(--font-family); background: var(--color-bg); color: var(--color-text); }
        body { padding: 20px; max-width: 1400px; margin: 0 auto; }
        .header { margin-bottom: 30px; text-align: center; color: white; }
        h1 { font-size: 32px; margin-bottom: 8px; font-weight: 600; }
        .subtitle { opacity: 0.9; font-size: 14px; }
        .nav-tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid rgba(255,255,255,0.2); flex-wrap: wrap; }
        .nav-tab { padding: 10px 16px; background: none; border: none; color: rgba(255,255,255,0.7); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; border-bottom: 3px solid transparent; margin-bottom: -2px; color: white; }
        .nav-tab.active { color: white; border-bottom-color: white; font-weight: 600; }
        .nav-tab:hover { color: white; }
        .view { display: none; }
        .view.active { display: block; }
        .card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 16px; }
        label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; color: var(--color-text); }
        input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select, textarea {
            width: 100%; padding: 10px 12px; border: 1px solid #d0d0d0; border-radius: 6px; font-family: var(--font-family); font-size: 14px; color: var(--color-text); background: white;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(2,162,188,0.1); }
        .btn { padding: 10px 16px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-family: var(--font-family); }
        .btn-primary { background: var(--color-primary); color: white; }
        .btn-primary:hover { background: var(--color-primary-hover); }
        .btn-secondary { background: white; color: var(--color-primary); border: 2px solid var(--color-primary); }
        .btn-secondary:hover { background: rgba(2,162,188,0.05); }
        .btn-success { background: var(--color-success); color: white; }
        .btn-success:hover { background: #219653; }
        .btn-danger { background: var(--color-error); color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
        .member-list { list-style: none; }
        .member-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 8px; }
        .member-info { flex: 1; }
        .member-name { font-weight: 500; font-size: 14px; }
        .member-contact { font-size: 12px; color: var(--color-text-secondary); }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .attendance-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .summary-item { background: #f5f5f5; padding: 12px; border-radius: 6px; border-left: 4px solid var(--color-primary); }
        .summary-label { font-size: 12px; color: var(--color-text-secondary); margin-bottom: 4px; }
        .summary-value { font-size: 18px; font-weight: 600; color: var(--color-primary); }
        .alert { padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; font-size: 14px; }
        .alert-success { background: rgba(40,167,69,0.1); color: #155724; border: 1px solid rgba(40,167,69,0.3); }
        .alert-error { background: rgba(220,53,69,0.1); color: #721c24; border: 1px solid rgba(220,53,69,0.3); }
        .actions { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
        .search-box { position: relative; margin-bottom: 20px; }
        .search-box input { padding-left: 36px; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-text-secondary); }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--color-text-secondary); }
        .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden; }
        th { background: rgba(2,162,188,0.05); padding: 12px; text-align: left; font-weight: 600; font-size: 12px; color: var(--color-text); border-bottom: 1px solid #e0e0e0; }
        td { padding: 12px; border-bottom: 1px solid #e0e0e0; font-size: 14px; }
        tr:hover { background: rgba(2,162,188,0.02); }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .status-active { background: rgba(40,167,69,0.15); color: #155724; }
        .status-inactive { background: rgba(102,102,102,0.15); color: #333; }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚õ™ Church Attendance Tracker</h1>
        <p class="subtitle">Connected to Neon Database ‚Ä¢ All three apps share member data</p>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchView('attendance')">üìã Attendance</button>
        <button class="nav-tab" onclick="switchView('members')">üë• Members</button>
        <button class="nav-tab" onclick="switchView('reports')">üìä Reports</button>
    </div>

    <!-- Attendance View -->
    <div id="attendance" class="view active">
        <div class="card">
            <h2>Record Attendance</h2>
            <div class="grid-2">
                <div class="form-group">
                    <label>Service Date</label>
                    <input type="date" id="serviceDate" />
                </div>
                <div class="form-group">
                    <label>Service Type</label>
                    <select id="serviceType">
                        <option value="">Select a service</option>
                        <option value="Sunday AM - EAC">Sunday AM - EAC</option>
                        <option value="Sunday School">Sunday School</option>
                        <option value="Sunday PM - NLPC">Sunday PM - NLPC</option>
                        <option value="Wednesday PM">Wednesday PM</option>
                        <option value="Revival Service">Revival Service</option>
                        <option value="Prayer Meeting">Prayer Meeting</option>
                    </select>
                </div>
            </div>
            <div id="attendanceAlert"></div>
        </div>

        <div class="card">
            <h3>Mark Attendance</h3>
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="memberSearch" placeholder="Search members..." />
            </div>
            <div id="membersList" class="member-list"></div>
        </div>

        <div class="card actions">
            <button class="btn btn-success" onclick="submitAttendance()">‚úì Save Attendance</button>
            <button class="btn btn-secondary" onclick="resetAttendance()">‚Üª Reset</button>
        </div>
    </div>

    <!-- Members View -->
    <div id="members" class="view">
        <div class="card">
            <h2>Manage Members</h2>
            <button class="btn btn-primary" onclick="showAddMemberForm()">+ Add Member</button>
            <div id="addMemberForm" style="display: none; margin-top: 20px;">
                <div class="grid-2">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="memberFirstName" placeholder="First name" />
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="memberLastName" placeholder="Last name" />
                    </div>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="memberEmail" placeholder="Email address" />
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="memberPhone" placeholder="Phone number" />
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Status</label>
                        <select id="memberStatus">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Visitor">Visitor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Join Date</label>
                        <input type="date" id="memberJoinDate" />
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-primary" onclick="saveMember()">Save Member</button>
                    <button class="btn btn-secondary" onclick="cancelAddMember()">Cancel</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Member Directory</h3>
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="directorySearch" placeholder="Search members..." />
            </div>
            <table id="membersTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="membersTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Reports View -->
    <div id="reports" class="view">
        <div class="card">
            <h2>Attendance Reports</h2>
            <div class="grid-2">
                <div class="form-group">
                    <label>From Date</label>
                    <input type="date" id="reportFromDate" />
                </div>
                <div class="form-group">
                    <label>To Date</label>
                    <input type="date" id="reportToDate" />
                </div>
            </div>
            <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
        </div>
        <div id="reportResults"></div>
    </div>

    <script>
        // Configuration
        const API_BASE = '/.netlify/functions/api';
        
        // Global state
        let members = [];
        let attendance = [];
        let selectedAttendees = new Set();

        // Initialize dates
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('serviceDate').value = today;
        document.getElementById('reportFromDate').value = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];
        document.getElementById('reportToDate').value = today;
        document.getElementById('memberJoinDate').value = today;

        // Load members from Neon
        async function loadMembers() {
            try {
                const response = await fetch(`${API_BASE}/members`);
                if (response.ok) {
                    members = await response.json();
                    renderMembersList();
                    showMembersTable();
                }
            } catch (err) { console.error('Error loading members:', err); }
        }

        // Load attendance from Neon
        async function loadAttendance() {
            try {
                const response = await fetch(`${API_BASE}/attendance`);
                if (response.ok) { attendance = await response.json(); }
            } catch (err) { console.error('Error loading attendance:', err); }
        }

        // View switching
        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(viewName).classList.add('active');
            event.target.classList.add('active');
            if (viewName === 'members') { renderMembersList(); showMembersTable(); }
        }

        // Render members list for attendance
        function renderMembersList() {
            const list = document.getElementById('membersList');
            const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
            const filtered = members.filter(m => `${m.firstName} ${m.lastName}`.toLowerCase().includes(searchTerm));
            
            if (filtered.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No members found</p></div>';
                return;
            }

            list.innerHTML = filtered.map((member) => `
                <div class="member-item">
                    <div class="member-info">
                        <div class="member-name">${member.firstName} ${member.lastName}</div>
                        <div class="member-contact">${member.email || ''}</div>
                    </div>
                    <input type="checkbox" ${selectedAttendees.has(member.id) ? 'checked' : ''} onchange="toggleAttendee('${member.id}', this.checked)">
                </div>
            `).join('');
        }

        function toggleAttendee(memberId, checked) {
            if (checked) { selectedAttendees.add(memberId); }
            else { selectedAttendees.delete(memberId); }
        }

        async function submitAttendance() {
            const serviceDate = document.getElementById('serviceDate').value;
            const serviceType = document.getElementById('serviceType').value;
            const alertEl = document.getElementById('attendanceAlert');

            if (!serviceDate || !serviceType) {
                showAlert(alertEl, 'Please select both date and service type', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/attendance`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: serviceDate,
                        serviceType: serviceType,
                        attendees: Array.from(selectedAttendees),
                        count: selectedAttendees.size
                    })
                });

                if (!response.ok) throw new Error('Failed to save');
                showAlert(alertEl, `‚úì Recorded ${selectedAttendees.size} attendees`, 'success');
                setTimeout(() => resetAttendance(), 2000);
            } catch (err) {
                console.error('Error:', err);
                showAlert(alertEl, 'Error saving attendance', 'error');
            }
        }

        function resetAttendance() {
            selectedAttendees.clear();
            document.getElementById('memberSearch').value = '';
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            renderMembersList();
        }

        // Member management
        function showAddMemberForm() { document.getElementById('addMemberForm').style.display = 'block'; }
        function cancelAddMember() { document.getElementById('addMemberForm').style.display = 'none'; }

        async function saveMember() {
            const firstName = document.getElementById('memberFirstName').value.trim();
            const lastName = document.getElementById('memberLastName').value.trim();
            const email = document.getElementById('memberEmail').value.trim();
            const phone = document.getElementById('memberPhone').value.trim();
            const status = document.getElementById('memberStatus').value;
            const joinDate = document.getElementById('memberJoinDate').value;

            if (!firstName || !lastName) { alert('Please enter first and last name'); return; }

            try {
                const response = await fetch(`${API_BASE}/members`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ firstName, lastName, email, phone, status, joinDate })
                });

                if (!response.ok) throw new Error('Failed to save');
                const newMember = await response.json();
                members.push(newMember);
                alert(`‚úì ${firstName} ${lastName} added!`);
                cancelAddMember();
                renderMembersList();
                showMembersTable();
            } catch (err) { console.error('Error:', err); alert('Error saving member'); }
        }

        function showMembersTable() {
            const tbody = document.getElementById('membersTableBody');
            const searchTerm = document.getElementById('directorySearch').value.toLowerCase();
            const filtered = members.filter(m => `${m.firstName} ${m.lastName}`.toLowerCase().includes(searchTerm) || m.email.toLowerCase().includes(searchTerm));

            tbody.innerHTML = filtered.map((member) => `
                <tr>
                    <td>${member.firstName} ${member.lastName}</td>
                    <td>${member.email || '‚Äî'}</td>
                    <td>${member.phone || '‚Äî'}</td>
                    <td><span class="status-badge ${member.status === 'Active' ? 'status-active' : 'status-inactive'}">${member.status}</span></td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteMember('${member.id}')">Delete</button></td>
                </tr>
            `).join('');
        }

        async function deleteMember(memberId) {
            if (!confirm('Are you sure?')) return;
            try {
                const response = await fetch(`${API_BASE}/members/${memberId}`, { method: 'DELETE' });
                if (response.ok) {
                    members = members.filter(m => m.id !== memberId);
                    showMembersTable();
                }
            } catch (err) { console.error('Error:', err); }
        }

        // Reports
        async function generateReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            const resultsEl = document.getElementById('reportResults');

            try {
                const response = await fetch(`${API_BASE}/attendance/report?from=${fromDate}&to=${toDate}`);
                if (!response.ok) throw new Error('Failed to generate');
                const { totalServices, totalAttendance, averageAttendance, serviceBreakdown } = await response.json();

                if (totalServices === 0) {
                    resultsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><p>No data</p></div>';
                    return;
                }

                resultsEl.innerHTML = `
                    <div class="card">
                        <h3>Report: ${fromDate} to ${toDate}</h3>
                        <div class="attendance-summary">
                            <div class="summary-item"><div class="summary-label">Total Services</div><div class="summary-value">${totalServices}</div></div>
                            <div class="summary-item"><div class="summary-label">Total Attendance</div><div class="summary-value">${totalAttendance}</div></div>
                            <div class="summary-item"><div class="summary-label">Average</div><div class="summary-value">${averageAttendance}</div></div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>By Service Type</h3>
                        <table><thead><tr><th>Service</th><th>Count</th></tr></thead><tbody>${Object.entries(serviceBreakdown).map(([type, count]) => `<tr><td>${type}</td><td>${count}</td></tr>`).join('')}</tbody></table>
                    </div>
                `;
            } catch (err) { console.error('Error:', err); resultsEl.innerHTML = '<div class="alert alert-error">Error</div>'; }
        }

        // Utilities
        function showAlert(el, message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            el.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            el.style.display = 'block';
            if (type === 'error') setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadMembers();
            loadAttendance();
            document.getElementById('memberSearch')?.addEventListener('input', renderMembersList);
            document.getElementById('directorySearch')?.addEventListener('input', showMembersTable);
        });
    </script>
</body>
</html>
